## Grouping and Aggregates

```sql

SELECT customer_id, count(*)
FROM rental
GROUP BY customer_id

```

### Aggregate Functions

Aggregate functions perform a specific operation over all rows in a group. Althoughy
every database server has its own set of specialty aggregate functions, the common
aggregate functions implemented by all major servers include:

- max() : Returns the maximum value within a set
- min() : Returns the minimum value "" "" ""
- avg(): Returns the average value accross a "" ""
- sum(): retunrs the sum of the values accross a set
- count(): Returns the number of values in a set

Here's a query that uses all of the common aggregate functions to analyze the data
on film rental payments:

```sql

SELECT MAX(amount) max_amt,
MIN(amount) min_amt,
AVG(amount) avg_amt,
SUM(amount) tot_amt,
COUNT(*) num_payments
FROM payment;
```

The same query applied to each row  

```sql

SELECT customer_id, MAX(amount) max_amt,
MIN(amount) min_amt,
AVG(amount) avg_amt,
SUM(amount) tot_amt,
COUNT(*) num_payments
FROM payment;
GROUP BY customer_id
```

#### Counting Distinct Values

When using the count() function to determine the number of members in each group,
you have your choice of counting all members in the group or counting only
the distinct values for a column accross all members of the group

For example, consider the following query:

```sql

SELECT COUNT(customer_id) num_rows,
COUNT(DISTINCT customer_id) num_customers
FROM payment;
```

### Grouping conditions

```sql

SELECT customer_id, count(*)
FROM rental
WHERE count(*) >= 40
GROUP BY customer_id;
```

The above condition will not work because the groups have not
been generated yet

```sql

SELECT customer_id, count(*)
FROM rental
GROUP BY customer_id
HAVING count(*) >= 40;

```

### Using Expressions

Along with using columns as arguments to aggregate functions, you can use
expressions as well. For example you may want to find the maximum number
of days between  when a film was rented and subsequently returned.

```sql

SELECT MAX(datediff(return_date, rental_date))
FROM rental;
```

### How Nulls Are Handled

When performing aggregations, or, any type of numeric calculation, you
should always consider how null values might affect the outcome of your
calculation.

```sql

CREATE TABLE number_tbl
(val SMALLINT);
```

### Generating Groups

#### Single-Column Grouping

```sql

SELECT actor_id, count(*)
FROM film_actor
GROUP BY actor_id;
```


#### Multicolumn Grouping

```sql

SELECT fa.actor_id, f.rating, count(*)
FROM film_actor fa
INNER JOIN film f
ON fa.film_id = f.film_id
GROUP BY fa.actor_id, f.rating
ORDER BY 1, 2;

```

#### Grouping via expressions

Along with using columns to group data, you can byuild groups based on the values
generated by expressions. COnsider the following query, which groups rental by
year:

```sql

SELECT extract(YEAR FROM rental_date) year,
COUNT(*) how_many
FROM rental
GROUP BY extract(YEAR FROM rental_date);
```
### Generating Rollups

In SQL a Rollup is a grouping operation that allows you to generate subtotals
and grand totals for a set of data. it is used to summarize data based on
multiple levels of aggregation.

```sql
SELECT fa.factor_id, f.rating, count(*)
FROM film_actor fa
INNER JOIN film f
ON fa.film_id = f.film_id
GROUP BY fa.factor_id, fa.rating WITH ROLLUP
ORDER BY 1, 2;

```
